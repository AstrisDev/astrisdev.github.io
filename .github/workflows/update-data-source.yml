name: Update Data Source

on:
    schedule:
        # Запускать каждые 12 часов для поиска новых марок
        - cron: "0 */12 * * *"
    workflow_dispatch:
        inputs:
            scrape_new:
                description: "Scrape new pages"
                required: false
                default: true
                type: boolean
            scrape_categories:
                description: "Update categories"
                required: false
                default: true
                type: boolean

jobs:
    update-data:
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: Setup Go
              uses: actions/setup-go@v4
              with:
                  go-version: "1.21"

            - name: Checkout tools
              uses: actions/checkout@v4
              with:
                  sparse-checkout: |
                      tools/
                  sparse-checkout-cone-mode: false

            - name: Checkout data fork
              uses: actions/checkout@v4
              with:
                  repository: ${{ github.repository_owner }}/russian-stamps # Ваш форк
                  token: ${{ secrets.DATA_REPO_TOKEN }} # Токен для записи в форк
                  path: data-repo

            - name: Build scraper
              run: |
                  cd tools
                  CGO_ENABLED=0 go build -o sfscrape -buildvcs=false ./cmd/sfscrape

            - name: Run scraper
              run: |
                  cd data-repo

                  # Настройка git
                  git config user.name "Stamps Data Bot"
                  git config user.email "stamps-bot@users.noreply.github.com"

                  # Флаги для скрейпера
                  SCRAPE_FLAGS=""
                  if [ "${{ github.event.inputs.scrape_new }}" = "true" ] || [ "${{ github.event_name }}" = "schedule" ]; then
                    SCRAPE_FLAGS="$SCRAPE_FLAGS -n"
                  fi
                  if [ "${{ github.event.inputs.scrape_categories }}" = "true" ] || [ "${{ github.event_name }}" = "schedule" ]; then
                    SCRAPE_FLAGS="$SCRAPE_FLAGS -c"
                  fi

                  # Запуск скрейпера
                  if [ -n "$SCRAPE_FLAGS" ]; then
                    echo "Running sfscrape with flags: $SCRAPE_FLAGS"
                    ../tools/sfscrape $SCRAPE_FLAGS .
                    
                    # Проверка изменений
                    if git status --porcelain | grep -q .; then
                      echo "Changes detected, committing..."
                      git add .
                      git commit -m "🤖 Auto-update stamps data - $(date '+%Y-%m-%d %H:%M:%S UTC')"
                      git push origin main
                      
                      # Уведомляем основной репозиторий о необходимости обновления
                      echo "DATA_UPDATED=true" >> $GITHUB_ENV
                    else
                      echo "No changes detected"
                      echo "DATA_UPDATED=false" >> $GITHUB_ENV
                    fi
                  fi

            - name: Trigger main repo deploy
              if: env.DATA_UPDATED == 'true'
              uses: actions/github-script@v7
              with:
                  script: |
                      github.rest.actions.createWorkflowDispatch({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        workflow_id: 'deploy-github-pages.yml',
                        ref: 'main'
                      })

name: Update Data Source

on:
    workflow_dispatch:
        inputs:
            scrape_new:
                description: "Scrape new pages"
                required: false
                default: true
                type: boolean
            scrape_categories:
                description: "Update categories"
                required: false
                default: true
                type: boolean

jobs:
    update-data:
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: Check repository access
              run: |
                  if [ -z "${{ secrets.DATA_REPO_TOKEN }}" ]; then
                    echo "âŒ DATA_REPO_TOKEN secret is not configured"
                    echo "GITHUB_TOKEN cannot write to other repositories"
                    echo "Please create a classic Personal Access Token with 'repo' scope"
                    echo "See DEPLOYMENT_SETUP.md for instructions"
                    exit 1
                  else
                    echo "âœ… DATA_REPO_TOKEN is configured"
                    echo "Repository owner: ${{ github.repository_owner }}"
                    echo "Target repository: ${{ github.repository_owner }}/russian-stamps"
                  fi

            - name: Setup Go
              uses: actions/setup-go@v4
              with:
                  go-version: "1.21"

            - name: Checkout tools
              uses: actions/checkout@v4
              with:
                  sparse-checkout: |
                      tools/
                  sparse-checkout-cone-mode: false

            - name: Checkout data fork
              uses: actions/checkout@v4
              with:
                  repository: ${{ github.repository_owner }}/russian-stamps
                  token: ${{ secrets.DATA_REPO_TOKEN }}
                  path: data-repo

            - name: Build scraper
              run: |
                  cd tools
                  CGO_ENABLED=0 go build -o sfscrape -buildvcs=false ./cmd/sfscrape

            - name: Run scraper
              run: |
                  cd data-repo

                  # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° git
                  git config user.name "Stamps Data Bot"
                  git config user.email "stamps-bot@users.noreply.github.com"

                  # Ð¤Ð»Ð°Ð³Ð¸ Ð´Ð»Ñ ÑÐºÑ€ÐµÐ¹Ð¿ÐµÑ€Ð°
                  SCRAPE_FLAGS=""
                  if [ "${{ github.event.inputs.scrape_new }}" = "true" ] || [ "${{ github.event_name }}" = "schedule" ]; then
                    SCRAPE_FLAGS="$SCRAPE_FLAGS -n"
                  fi
                  if [ "${{ github.event.inputs.scrape_categories }}" = "true" ] || [ "${{ github.event_name }}" = "schedule" ]; then
                    SCRAPE_FLAGS="$SCRAPE_FLAGS -c"
                  fi

                  # Ð—Ð°Ð¿ÑƒÑÐº ÑÐºÑ€ÐµÐ¹Ð¿ÐµÑ€Ð°
                  if [ -n "$SCRAPE_FLAGS" ]; then
                    echo "Running sfscrape with flags: $SCRAPE_FLAGS"
                    ../tools/sfscrape $SCRAPE_FLAGS .
                    
                    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹
                    if git status --porcelain | grep -q .; then
                      echo "Changes detected, committing..."
                      git add .
                      git commit -m "ðŸ¤– Auto-update stamps data - $(date '+%Y-%m-%d %H:%M:%S UTC')"
                      git push origin main
                      
                      # Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÑÐµÐ¼ Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ Ð¾ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ
                      echo "DATA_UPDATED=true" >> $GITHUB_ENV
                    else
                      echo "No changes detected"
                      echo "DATA_UPDATED=false" >> $GITHUB_ENV
                    fi
                  fi

            - name: Trigger main repo deploy
              if: env.DATA_UPDATED == 'true'
              uses: actions/github-script@v7
              with:
                  script: |
                      github.rest.actions.createWorkflowDispatch({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        workflow_id: 'update-and-deploy.yml',
                        ref: 'main'
                      })
